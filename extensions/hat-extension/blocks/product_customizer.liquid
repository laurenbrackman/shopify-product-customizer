{{ 'product_customizer.css' | asset_url | stylesheet_tag }}
{%- liquid
  assign should_display = true
  if block.settings.display_tag != blank
    assign should_display = false
    if product.tags contains block.settings.display_tag
      assign should_display = true
    endif
  endif
-%}

{%- if should_display -%}
<div class="pc-container" style="padding-top: {{ block.settings.padding_top }}px; padding-bottom: {{ block.settings.padding_bottom }}px;">
{%- if block.settings.heading != blank -%}
  <h2>{{ block.settings.heading }}</h2>
{%- endif -%}
{%- if block.settings.description != blank -%}
  <p class="pc-description">{{ block.settings.description }}</p>
{%- endif -%}
{%- assign hat_transparent_img = product.metafields.custom.transparent_image.value | default: product.featured_image -%}
<div class="pc-preview" id="pc-preview" aria-hidden="false">
  <img id="pc-preview-img" 
       src="{{ hat_transparent_img | image_url: width: 1600 }}" 
       alt="{{ product.title | escape }}"
       {%- if product.metafields.custom.height -%}data-height="{{ product.metafields.custom.height.value }}"{%- endif -%}>
  <button id="pc-export-btn" class="pc-export-btn" type="button">Export PNG</button>
</div>

{%- assign coll = block.settings.source_collection -%}
<div id="image-switcher-root" class="pc-grid"
     data-delete-icon="{{ 'x-icon.svg' | asset_url }}"
     data-rotate-left-icon="{{ 'rotate-left.svg' | asset_url }}"
     data-rotate-right-icon="{{ 'rotate-right.svg' | asset_url }}"
     data-backward-icon="{{ 'send-backward.svg' | asset_url }}"
     data-forward-icon="{{ 'bring-forward.svg' | asset_url }}">
  {%- if coll and coll.products_count > 0 -%}
    {%- for p in coll.products -%}
      {%- if p.featured_image != blank -%}
        {%- assign transparent_img = p.metafields.custom.transparent_image.value | default: p.featured_image -%}
        <div class="pc-grid-item">
          <button class="pc-choice"
                  data-index="{{ forloop.index }}"
                  data-src="{{ transparent_img | image_url: width: 1600 }}"
                  data-handle="{{ p.handle }}"
                  data-title="{{ p.title | escape }}"
                  {%- if p.metafields.custom.height -%}data-height="{{ p.metafields.custom.height.value }}"{%- endif -%}
                  {%- if p.metafields.custom.width -%}data-width="{{ p.metafields.custom.width.value }}"{%- endif -%}>
            <img src="{{ transparent_img | image_url: width: 320 }}" alt="{{ p.title | escape }}">
          </button>
        </div>
      {%- endif -%}
    {%- endfor -%}
  {%- endif -%}
</div>
</div>
{%- endif -%}

{% schema %}
{
  "name": "Product Customizer",
  "target": "section",
  "templates": ["product"],
  "settings": [
    
    {
      "type": "text",
      "id": "display_tag",
      "label": "Product tag to match",
      "info": "Enter a single tag. The block will show when the product has this tag."
    },
    {
      "type": "text",
      "id": "heading",
      "label": "Heading",
      "default": "Build a Custom Hat"
    },
    {
      "type": "textarea",
      "id": "description",
      "label": "Description"
    },
    {
      "type": "collection",
      "id": "source_collection",
      "label": "Collection to display"
    },
    {
      "type": "range",
      "id": "padding_top",
      "min": 0,
      "max": 100,
      "step": 5,
      "unit": "px",
      "label": "Top padding",
      "default": 20
    },
    {
      "type": "range",
      "id": "padding_bottom",
      "min": 0,
      "max": 100,
      "step": 5,
      "unit": "px",
      "label": "Bottom padding",
      "default": 20
    }
  ]
}
{% endschema %}

{{ 'product_customizer.js' | asset_url | script_tag }}
